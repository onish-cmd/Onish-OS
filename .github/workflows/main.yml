name: Build Onish-OS v0.9
on: [push]

jobs:
  build_os:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        target: [hardware, qemu]
    
    steps:
      - name: Maximize Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 1024
          swap-size-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config build-essential ninja-build automake autoconf \
          libtool wget curl git gcc libssl-dev bc squashfs-tools jq scons parallel tree \
          device-tree-compiler python3-pip python3-setuptools fakeroot genext2fs mtools \
          rsync dosfstools expect bison flex libncurses-dev u-boot-tools vim-common unzip \
          gcc-riscv64-linux-gnu 
          pip3 install jinja2 setuptools

      - name: Build Rust Init & Overlay Structure
        run: |
          rustup target add riscv64gc-unknown-linux-musl
          
          CARGO_TARGET_RISCV64GC_UNKNOWN_LINUX_MUSL_LINKER=riscv64-linux-gnu-gcc \
          RUSTFLAGS="-C target-feature=+crt-static" \
          cargo build --release --target riscv64gc-unknown-linux-musl -p init
          
          mkdir -p overlay/sbin overlay/bin overlay/etc/apk/keys overlay/proc overlay/sys \
                   overlay/dev overlay/tmp overlay/root overlay/etc/skel overlay/usr/bin
          
          cp target/riscv64gc-unknown-linux-musl/release/init overlay/sbin/init
          chmod +x overlay/sbin/init

      - name: Configure APK & Shells
        run: |
          cat <<EOF > overlay/etc/apk/repositories
          https://dl-cdn.alpinelinux.org/alpine/v3.20/main
          https://dl-cdn.alpinelinux.org/alpine/v3.20/community
          EOF

          curl -L https://alpinelinux.org/keys/alpine-devel@lists.alpinelinux.org-616ae3bc.rsa.pub \
               -o overlay/etc/apk/keys/alpine-devel@lists.alpinelinux.org-616ae3bc.rsa.pub

          cat <<EOF > overlay/root/.bashrc
          alias ls='ls --color=auto'
          alias ll='ls -alF'
          PS1='\[\033[01;32m\]Onish-OS\[\033[00m\] \w \$ '
          EOF

          cat <<EOF > overlay/root/.zshrc
          alias ls='ls --color=auto'
          alias ll='ls -al'
          PROMPT='%F{green}Onish-OS%f %~ %# '
          setopt CORRECT
          setopt AUTO_CD
          EOF

          cp overlay/root/.bashrc overlay/etc/skel/
          cp overlay/root/.zshrc overlay/etc/skel/

      - name: Create System Profile
        run: |
          cat <<EOF > overlay/etc/profile
          export PATH=/usr/bin:/bin:/usr/sbin:/sbin
          export TERM=xterm
          export HOME=/root

          if ! ip addr show eth0 | grep -q "inet "; then
              ip link set eth0 up
              udhcpc -i eth0 > /dev/null
          fi

          echo "------------------------------------------------"
          echo "     WELCOME TO ONISH-OS v0.9 (GPL-3.0)         "
          echo "   Core: Rust Init | Package Manager: APK       "
          echo "------------------------------------------------"
          EOF

      - name: Manual APK Injection (Force Download)
        run: |
          curl -L --insecure https://dl-cdn.alpinelinux.org/alpine/v3.20/main/riscv64/apk-tools-static-2.14.4-r0.apk -o apk-static.apk
          tar -xzf apk-static.apk sbin/apk.static
          mkdir -p overlay/sbin
          mv sbin/apk.static overlay/sbin/apk
          chmod +x overlay/sbin/apk
          ls -lh overlay/sbin/apk

      - name: Build Full OS
        run: |
          OUTPUT_DIR="${{ github.workspace }}/out"
          mkdir -p "$OUTPUT_DIR"

          if [ "${{ matrix.target }}" == "qemu" ]; then
            git clone https://github.com/buildroot/buildroot.git --depth=1 --branch=2024.02.x
            cd buildroot
            make qemu_riscv64_virt_defconfig
            {
              echo "BR2_ROOTFS_OVERLAY=\"${{ github.workspace }}/overlay\""
              echo 'BR2_INIT_NONE=y'
              echo 'BR2_PACKAGE_BASH=y'
              echo 'BR2_PACKAGE_ZSH=y'
            } >> .config
            make olddefconfig
            make -j$(nproc)
            cp output/images/Image "$OUTPUT_DIR/"
            cp output/images/rootfs.ext2 "$OUTPUT_DIR/"
          else
            git clone https://github.com/milkv-duo/duo-buildroot-sdk.git --depth=1
            cd duo-buildroot-sdk
            git clone https://github.com/milkv-duo/host-tools.git --depth=1
            mkdir -p host-tools/gcc/riscv64-linux-musl-x86_64/bin
            sudo ln -sf /usr/bin/dtc host-tools/gcc/riscv64-linux-musl-x86_64/bin/dtc
            CONF="buildroot-2021.05/configs/milkv-duo_musl_riscv64_defconfig"
            {
              echo "BR2_ROOTFS_OVERLAY=\"${{ github.workspace }}/overlay\""
              echo "BR2_PACKAGE_BASH=y"
            } >> $CONF
            ./build.sh milkv-duo-sd
            cp out/*.img "$OUTPUT_DIR/"
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: onish-os-v0.9-${{ matrix.target }}
          path: out/