name: Build Onish-OS v0.8
on: [push]

jobs:
  build_os:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        target: [hardware, qemu]
    
    steps:
      - name: Maximize Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 1024
          swap-size-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config build-essential ninja-build automake autoconf \
          libtool wget curl git gcc libssl-dev bc squashfs-tools jq scons parallel tree \
          device-tree-compiler python3-pip python3-setuptools fakeroot genext2fs mtools \
          rsync dosfstools expect bison flex libncurses-dev u-boot-tools vim-common unzip \
          gcc-riscv64-linux-gnu 

          pip3 install jinja2 setuptools

      - name: Build Rust Init
        run: |
          # 1. Add the RISC-V Musl target
          rustup target add riscv64gc-unknown-linux-musl
          
          # 2. Build Init (Static linking for Musl)
          CARGO_TARGET_RISCV64GC_UNKNOWN_LINUX_MUSL_LINKER=riscv64-linux-gnu-gcc \
          RUSTFLAGS="-C target-feature=+crt-static" \
          cargo build --release --target riscv64gc-unknown-linux-musl -p init
          
          # 3. Create RootFS Overlay Structure
          mkdir -p overlay/sbin overlay/bin overlay/etc overlay/proc overlay/sys overlay/dev overlay/tmp overlay/root
          
          # 4. Copy Init to the correct location
          cp target/riscv64gc-unknown-linux-musl/release/init overlay/sbin/init
          chmod +x overlay/sbin/init

      - name: Create System Profile (Network + Branding)
        run: |
          cat <<EOF > overlay/etc/profile
          #!/bin/sh
          export PATH=/usr/bin:/bin:/usr/sbin:/sbin
          export TERM=xterm
          export HOME=/root
          export PS1='\[\033[01;32m\]Onish-OS\[\033[00m\] \w \$ '

          echo "------------------------------------------------"
          echo "   WELCOME TO ONISH-OS v0.8 (Pre-release)       "
          echo "   Building for Milk-V Duo | Running Bash       "
          echo "------------------------------------------------"

          # Network Fix: Linux inits drivers, we init the link
          echo "[ OK ] Starting Network (eth0)..."
          ip link set eth0 up
          udhcpc -i eth0 & 
          EOF
          chmod +x overlay/etc/profile

      - name: Build Full OS
        run: |
          OUTPUT_DIR="${{ github.workspace }}/out"
          mkdir -p "$OUTPUT_DIR"

          if [ "${{ matrix.target }}" == "qemu" ]; then
            # --- QEMU VIRT BUILD ---
            git clone https://github.com/buildroot/buildroot.git --depth=1 --branch=2024.02.x
            cd buildroot
            make qemu_riscv64_virt_defconfig
            
            # Inject Onish-OS Settings
            echo "BR2_ROOTFS_OVERLAY=\"${{ github.workspace }}/overlay\"" >> .config
            echo 'BR2_TARGET_GENERIC_GETTY_PORT="ttyS0"' >> .config
            echo 'BR2_INIT_NONE=y' >> .config 
            echo 'BR2_PACKAGE_BASH=y' >> .config
            echo 'BR2_SYSTEM_BIN_SH_BASH=y' >> .config
            
            make olddefconfig
            make -j$(nproc)
            cp output/images/Image "$OUTPUT_DIR/"
            cp output/images/rootfs.ext2 "$OUTPUT_DIR/"
          else
            # --- MILK-V HARDWARE BUILD ---
            git clone https://github.com/milkv-duo/duo-buildroot-sdk.git --depth=1
            cd duo-buildroot-sdk
            git clone https://github.com/milkv-duo/host-tools.git --depth=1
            
            mkdir -p host-tools/gcc/riscv64-linux-musl-x86_64/bin
            sudo ln -sf /usr/bin/dtc host-tools/gcc/riscv64-linux-musl-x86_64/bin/dtc

            CONF="buildroot-2021.05/configs/milkv-duo_musl_riscv64_defconfig"
            
            # Inject Onish-OS Settings into Hardware Defconfig
            echo "BR2_ROOTFS_OVERLAY=\"${{ github.workspace }}/overlay\"" >> $CONF
            echo "BR2_PACKAGE_BASH=y" >> $CONF
            echo "BR2_SYSTEM_BIN_SH_BASH=y" >> $CONF
            
            export BR2_JLEVEL=2
            ./build.sh milkv-duo-sd
            
            cp out/*.img "$OUTPUT_DIR/"
            find . -name "vmlinux" -type f -exec cp {} "$OUTPUT_DIR/" \;
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: onish-os-v0.8-${{ matrix.target }}
          path: out/
