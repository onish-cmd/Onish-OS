name: Build Onish-OS v1.0

on:
  workflow_dispatch:
    inputs:
      use_incremental:
        description: 'Use incremental build?'
        required: true
        default: 'yes'
        type: choice
        options: [ 'yes', 'no' ]

jobs:
  build_os:
    runs-on: ubuntu-24.04
    permissions:
      actions: write
    strategy:
      matrix:
        target: [hardware, qemu]
    
    steps:
      - name: Maximize Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 4096
          swap-size-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config build-essential ninja-build automake autoconf \
          libtool wget curl git gcc libssl-dev bc squashfs-tools jq scons parallel tree \
          device-tree-compiler python3-pip python3-setuptools fakeroot rsync dosfstools \
          bison flex libncurses-dev u-boot-tools file expect mtools genext2fs lld

      - name: Build Your Rust Init
        run: |
          rustup target add riscv64gc-unknown-linux-musl
          export RUSTFLAGS="-C linker=rust-lld -C target-feature=+crt-static -C link-arg=-static"
          cargo build --release --target riscv64gc-unknown-linux-musl
          
          # Create universal overlay
          mkdir -p ${{ github.workspace }}/overlay/sbin
          cp target/riscv64gc-unknown-linux-musl/release/init ${{ github.workspace }}/overlay/sbin/init
          cp target/riscv64gc-unknown-linux-musl/release/init ${{ github.workspace }}/overlay/init
          chmod +x ${{ github.workspace }}/overlay/init
          chmod +x ${{ github.workspace }}/overlay/sbin/init

      - name: Inject APK Package Manager
        run: |
          mkdir -p ${{ github.workspace }}/overlay/usr/bin
          curl -L https://gitlab.alpinelinux.org/api/v4/projects/5/packages/generic/v2.14.0/riscv64/apk.static -o ${{ github.workspace }}/overlay/usr/bin/apk
          chmod +x ${{ github.workspace }}/overlay/usr/bin/apk

      - name: Create Global Device Table
        run: |
          # This forces permissions regardless of the build target
          cat <<EOF > ${{ github.workspace }}/onish_device_table.txt
          /init f 755 0 0 - - - - -
          /sbin/init f 755 0 0 - - - - -
          EOF

      - name: Build Full OS
        run: |
          OUTPUT_DIR="${{ github.workspace }}/out"
          mkdir -p "$OUTPUT_DIR"

          if [ "${{ matrix.target }}" == "qemu" ]; then
            [ ! -d buildroot ] && git clone https://github.com/buildroot/buildroot.git --depth=1 --branch=2024.02.x
            cd buildroot
            make qemu_riscv64_virt_defconfig
            
            # 1. Force the Overlay and Device Table paths
            echo "BR2_ROOTFS_OVERLAY=\"${{ github.workspace }}/overlay\"" >> .config
            echo "BR2_ROOTFS_DEVICE_TABLE=\"${{ github.workspace }}/onish_device_table.txt\"" >> .config
            
            # 2. Merge your specific OS config
            ./support/kconfig/merge_config.sh -m .config ../onish_os.config
            make olddefconfig
            make -j$(nproc)
            
            cp output/images/Image "$OUTPUT_DIR/"
            cp output/images/rootfs.ext2 "$OUTPUT_DIR/"
          else
            [ ! -d duo-buildroot-sdk ] && git clone https://github.com/milkv-duo/duo-buildroot-sdk.git --depth=1
            cd duo-buildroot-sdk
            
            # 1. Find the SDK's internal Buildroot directory
            SDK_BR_DIR="buildroot-2021.05"
            SDK_CONF="buildroot-2021.05/configs/milkv-duo_musl_riscv64_defconfig"
            
            # 2. Inject Overlay & Device Table into the SDK's hardware config
            echo "BR2_ROOTFS_OVERLAY=\"${{ github.workspace }}/overlay\"" >> $SDK_CONF
            echo "BR2_ROOTFS_DEVICE_TABLE=\"${{ github.workspace }}/onish_device_table.txt\"" >> $SDK_CONF
            
            # 3. Merge Onish-OS specific tweaks
            cat ../onish_os.config >> $SDK_CONF
            
            # 4. Run the Milk-V custom build script
            ./build.sh milkv-duo-sd
            cp out/*.img "$OUTPUT_DIR/"
          fi

      - name: Final Integrity Check
        run: |
          echo "Listing the root of the generated OS structure..."
          if [ "${{ matrix.target }}" == "qemu" ]; then
            ls -l buildroot/output/target/init
          else
            ls -l duo-buildroot-sdk/buildroot-2021.05/output/target/init
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: onish-os-v1.0-${{ matrix.target }}
          path: out/