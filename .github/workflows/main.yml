name: Build Onish-OS v0.9
on: [push]

jobs:
  build_os:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        target: [hardware, qemu]
    
    steps:
      - name: Maximize Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 1024
          swap-size-mb: 2048
          remove-dotnet: 'true'
          remove-android: 'true'

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config build-essential ninja-build automake autoconf \
          libtool wget curl git gcc libssl-dev bc squashfs-tools jq scons parallel tree \
          device-tree-compiler python3-pip python3-setuptools fakeroot genext2fs mtools \
          rsync dosfstools expect bison flex libncurses-dev u-boot-tools vim-common unzip \
          gcc-riscv64-linux-gnu file
          pip3 install jinja2 setuptools

      - name: Build Rust Init & Overlay Structure
        run: |
          rustup target add riscv64gc-unknown-linux-musl
          CARGO_TARGET_RISCV64GC_UNKNOWN_LINUX_MUSL_LINKER=riscv64-linux-gnu-gcc \
          RUSTFLAGS="-C target-feature=+crt-static" \
          cargo build --release --target riscv64gc-unknown-linux-musl -p init
          
          mkdir -p overlay/sbin overlay/bin overlay/etc/apk/keys overlay/proc overlay/sys \
                   overlay/dev overlay/tmp overlay/root overlay/etc/skel overlay/usr/bin
          
          cp target/riscv64gc-unknown-linux-musl/release/init overlay/sbin/init
          chmod +x overlay/sbin/init

      - name: Manual APK Injection (Multi-Source Failover)
        run: |
          mkdir -p overlay/sbin
          
          # Try Source A (Fastly CDN)
          echo "Trying Source A..."
          curl -L --insecure --user-agent "Mozilla/5.0" \
            https://dl-cdn.alpinelinux.org/alpine/v3.20/main/riscv64/apk-tools-static-2.14.4-r1.apk -o apk.apk || true

          # Try Source B (Kernel.org) if A was fake/small
          if [ ! -f apk.apk ] || [ $(stat -c%s apk.apk) -lt 10000 ]; then
            echo "Source A failed, trying Source B (Kernel.org)..."
            curl -L --insecure https://mirrors.edge.kernel.org/alpine/v3.20/main/riscv64/apk-tools-static-2.14.4-r1.apk -o apk.apk || true
          fi

          # Try Source C (GitLab Direct) if B failed
          if [ ! -f apk.apk ] || [ $(stat -c%s apk.apk) -lt 10000 ]; then
            echo "Source B failed, trying Source C (GitLab)..."
            curl -L --insecure https://gitlab.alpinelinux.org/alpine/apk-tools/-/releases/v2.14.4/downloads/apk.static.riscv64 -o overlay/sbin/apk
            chmod +x overlay/sbin/apk
          else
            # If we got a real .apk file from A or B, extract the binary
            echo "Extracting binary from .apk package..."
            tar -xzf apk.apk sbin/apk.static
            mv sbin/apk.static overlay/sbin/apk
            chmod +x overlay/sbin/apk
          fi

          # FINAL VERIFICATION: Fail the build if APK is still missing or empty
          if [ ! -s overlay/sbin/apk ]; then
            echo "CRITICAL ERROR: APK binary could not be downloaded from any source!"
            exit 1
          fi
          echo "SUCCESS: APK binary ready. Size: $(ls -lh overlay/sbin/apk | awk '{print $5}')"

      - name: Configure Repos & Profiles
        run: |
          # Add Repos
          cat <<EOF > overlay/etc/apk/repositories
          https://dl-cdn.alpinelinux.org/alpine/v3.20/main
          https://dl-cdn.alpinelinux.org/alpine/v3.20/community
          EOF

          # Get Security Keys
          curl -L --insecure https://alpinelinux.org/keys/alpine-devel@lists.alpinelinux.org-616ae3bc.rsa.pub \
               -o overlay/etc/apk/keys/alpine-devel@lists.alpinelinux.org-616ae3bc.rsa.pub

          # Profile with 0.9 Banner
          cat <<EOF > overlay/etc/profile
          export PATH=/usr/bin:/bin:/usr/sbin:/sbin
          export TERM=xterm
          export HOME=/root

          if ! ip addr show eth0 | grep -q "inet "; then
              ip link set eth0 up
              udhcpc -i eth0 > /dev/null 2>&1
          fi

          echo "------------------------------------------------"
          echo "     WELCOME TO ONISH-OS v0.9 (GPL-3.0)         "
          echo "   Core: Rust Init | Package Manager: APK       "
          echo "------------------------------------------------"
          EOF

      - name: Build Full OS
        run: |
          OUTPUT_DIR="${{ github.workspace }}/out"
          mkdir -p "$OUTPUT_DIR"

          if [ "${{ matrix.target }}" == "qemu" ]; then
            git clone https://github.com/buildroot/buildroot.git --depth=1 --branch=2024.02.x
            cd buildroot
            make qemu_riscv64_virt_defconfig
            {
              echo "BR2_ROOTFS_OVERLAY=\"${{ github.workspace }}/overlay\""
              echo 'BR2_INIT_NONE=y'
              echo 'BR2_PACKAGE_BASH=y'
              echo 'BR2_PACKAGE_ZSH=y'
            } >> .config
            make olddefconfig
            make -j$(nproc)
            cp output/images/Image "$OUTPUT_DIR/"
            cp output/images/rootfs.ext2 "$OUTPUT_DIR/"
          else
            git clone https://github.com/milkv-duo/duo-buildroot-sdk.git --depth=1
            cd duo-buildroot-sdk
            git clone https://github.com/milkv-duo/host-tools.git --depth=1
            mkdir -p host-tools/gcc/riscv64-linux-musl-x86_64/bin
            sudo ln -sf /usr/bin/dtc host-tools/gcc/riscv64-linux-musl-x86_64/bin/dtc
            CONF="buildroot-2021.05/configs/milkv-duo_musl_riscv64_defconfig"
            {
              echo "BR2_ROOTFS_OVERLAY=\"${{ github.workspace }}/overlay\""
              echo "BR2_PACKAGE_BASH=y"
            } >> $CONF
            ./build.sh milkv-duo-sd
            cp out/*.img "$OUTPUT_DIR/"
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: onish-os-v0.9-${{ matrix.target }}
          path: out/
