name: Build Onish-OS Full
on: [push]

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config build-essential ninja-build automake autoconf \
          libtool wget curl git gcc libssl-dev bc slib squashfs-tools jq python3-distutils \
          scons parallel tree device-tree-compiler python3-pip python3-setuptools \
          fakeroot genext2fs mtools rsync dosfstools expect
          pip3 install jinja2

      - name: Build Rust Init (Workspace Mode)
        run: |
          rustup target add riscv64gc-unknown-linux-gnu
          # Build specifically the init crate as a static binary
          cargo build --release --target riscv64gc-unknown-linux-gnu -p init
          
          # Create the overlay structure
          mkdir -p overlay/sbin
          mkdir -p overlay/bin
          
          # Move your init to the system path
          cp target/riscv64gc-unknown-linux-gnu/release/init overlay/sbin/init
          chmod +x overlay/sbin/init

      - name: Build Full OS Image
        run: |
          # 1. Clone the SDK (Pinned to Duo-SD version)
          git clone https://github.com/milkv-duo/duo-buildroot-sdk.git --depth=1
          cd duo-buildroot-sdk
          
          # 2. Add the host-tools (Compilers)
          git clone https://github.com/milkv-duo/host-tools.git --depth=1
          
          # 3. CONFIGURE FOR "EVERYTHING"
          # We use the musl config but force it to include GNU tools
          CONF="buildroot-2021.05/configs/milkv-duo_musl_riscv64_defconfig"
          
          echo "BR2_PACKAGE_BASH=y" >> $CONF
          echo "BR2_PACKAGE_COREUTILS=y" >> $CONF
          echo "BR2_PACKAGE_PROCPS_NG=y" >> $CONF # Gives you 'ps', 'top', etc.
          echo "BR2_TARGET_UBOOT_BOARD_DEFCONFIG="qemu-riscv64_smode" >> $CONF
          echo "BR2_TARGET_UBOOT=y" >> $CONF
          
          # 4. Inject the Rust Overlay
          # This tells Buildroot to merge your 'overlay' folder into the OS
          echo "BR2_ROOTFS_OVERLAY=\"$(pwd)/../overlay\"" >> $CONF

          # 5. Build! (Infinite time is our friend here)
          ./build.sh milkv-duo-sd

      - name: Upload Kernel Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: onish-os-v0.4-kernel-pack
          path: |
            buildroot/output/images/Image
            buildroot/output/images/vmlinux
            buildroot/output/images/boot.sd
            
      - name: Upload SD Image
        uses: actions/upload-artifact@v4
        with:
          name: Onish-OS-SD-Image
          path: duo-buildroot-sdk/out/*.img
          
